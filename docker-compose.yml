services:
  # ---------- Next.js Apps ----------
  public:
    build:
      context: .
      dockerfile: apps/public/Dockerfile.dev
    environment:
      - NODE_OPTIONS=--max-old-space-size=3072
    mem_limit: 4g
    ports:
      - "4000:4000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/public/node_modules
      - /app/apps/public/.next
      - ./apps/public/.env.docker:/app/apps/public/.env.local:ro
    depends_on:
      - mysql

  admin:
    build:
      context: .
      dockerfile: apps/admin/Dockerfile.dev
    environment:
      - NODE_OPTIONS=--max-old-space-size=3072
    mem_limit: 4g
    ports:
      - "4100:4100"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/admin/node_modules
      - /app/apps/admin/.next
      - ./apps/admin/.env.docker:/app/apps/admin/.env.local:ro
    depends_on:
      - mysql

  # ---------- External Services ----------
  mysql:
    image: mysql:8.4.7
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    ports:
      - "25061:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    restart: unless-stopped

  stripe:
    image: stripe/stripe-cli:v1.35.0
    environment:
      STRIPE_DEVICE_NAME: docker
      STRIPE_API_KEY: ${STRIPE_API_KEY}
    command: listen --forward-to admin:4100/stripe/webhook/clover
    restart: unless-stopped
    depends_on:
      - admin

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "1035:1025"
      - "8035:8025"

volumes:
  mysql-data:
    external: true
    name: mpga_dev-data
